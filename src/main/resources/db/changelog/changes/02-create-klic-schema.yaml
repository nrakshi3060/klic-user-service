databaseChangeLog:
  - changeSet:
      id: create-klic-schema-and-tables
      author: gemini
      changes:
        - sql: |
            CREATE SCHEMA IF NOT EXISTS  klic;


            CREATE EXTENSION IF NOT EXISTS citext;
            CREATE EXTENSION IF NOT EXISTS postgis;

            CREATE TABLE IF NOT EXISTS klic.users (
                id UUID PRIMARY KEY,
                first_name VARCHAR(100) NOT NULL,
                last_name VARCHAR(100) NOT NULL,
                username VARCHAR(50) NOT NULL,
                email CITEXT UNIQUE CHECK (length(email) <= 254),
                signup_location GEOGRAPHY(POINT, 4326),
                create_date_time TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,
                update_date_time TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP
            );

            CREATE TYPE klic.post_type AS ENUM ('PHOTO', 'VIDEO', 'TEXT');

            CREATE TABLE IF NOT EXISTS klic.posts (
                id UUID PRIMARY KEY,
                user_id UUID NOT NULL,
                post_description TEXT NOT NULL,
                post_type klic.post_type NOT NULL,
                total_likes INTEGER DEFAULT 0,
                total_comments INTEGER DEFAULT 0,
                create_date_time TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,
                update_date_time TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,
                CONSTRAINT fk_posts_user FOREIGN KEY (user_id)
                    REFERENCES klic.users (id) ON DELETE CASCADE
            );

            CREATE EXTENSION IF NOT EXISTS postgis;

            CREATE TABLE IF NOT EXISTS klic.media (
                id UUID PRIMARY KEY,
                post_id UUID NOT NULL,
                user_id UUID NOT NULL,
                media_path TEXT NOT NULL,
                taken_location GEOGRAPHY(POINT, 4326),
                uploaded_location GEOGRAPHY(POINT, 4326),
                create_date_time TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,
                update_date_time TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,
                CONSTRAINT fk_media_post FOREIGN KEY (post_id)
                    REFERENCES klic.posts (id) ON DELETE CASCADE,
                CONSTRAINT fk_media_user FOREIGN KEY (user_id)
                    REFERENCES klic.users (id) ON DELETE CASCADE
            );


            CREATE TABLE IF NOT EXISTS klic.post_comments (
                id UUID PRIMARY KEY,
                post_id UUID NOT NULL,
                user_id UUID NOT NULL,
                parent_comment_id UUID NULL,
                comment_text TEXT NOT NULL,
                total_likes INTEGER DEFAULT 0,
                create_date_time TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,
                update_date_time TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,

                -- Foreign key to POSTS table
                CONSTRAINT fk_comment_post
                    FOREIGN KEY (post_id)
                    REFERENCES klic.posts (id)
                    ON DELETE CASCADE,

                -- Foreign key to USERS table
                CONSTRAINT fk_comment_user
                    FOREIGN KEY (user_id)
                    REFERENCES klic.users (id)
                    ON DELETE CASCADE,

                -- Self-referencing foreign key to support comment replies
                CONSTRAINT fk_parent_comment
                    FOREIGN KEY (parent_comment_id)
                    REFERENCES klic.post_comments (id)
                    ON DELETE CASCADE
            );

            CREATE TABLE IF NOT EXISTS klic.post_likes (
                id UUID PRIMARY KEY,
                post_id UUID NOT NULL,
                user_id UUID NOT NULL,
                is_like BOOLEAN DEFAULT TRUE,
                create_date_time TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,

                CONSTRAINT fk_post_like_post
                    FOREIGN KEY (post_id)
                    REFERENCES klic.posts (id)
                    ON DELETE CASCADE,

                CONSTRAINT fk_post_like_user
                    FOREIGN KEY (user_id)
                    REFERENCES klic.users (id)
                    ON DELETE CASCADE,

                -- Ensure a user can only like the same post once
                CONSTRAINT uq_post_like_user_post UNIQUE (post_id, user_id)
            );

            CREATE TABLE IF NOT EXISTS klic.comment_likes (
                id UUID PRIMARY KEY,
                comment_id UUID NOT NULL,
                user_id UUID NOT NULL,
                is_like BOOLEAN DEFAULT TRUE,
                create_date_time TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,
                update_date_time TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,

                CONSTRAINT fk_comment_like_comment
                    FOREIGN KEY (comment_id)
                    REFERENCES klic.post_comments (id)
                    ON DELETE CASCADE,

                CONSTRAINT fk_comment_like_user
                    FOREIGN KEY (user_id)
                    REFERENCES klic.users (id)
                    ON DELETE CASCADE,

                CONSTRAINT uq_comment_like_user_comment
                    UNIQUE (comment_id, user_id)
            );

            CREATE TABLE IF NOT EXISTS klic.user_followers (
                id UUID PRIMARY KEY,
                user_id UUID NOT NULL,        -- The user being followed
                follower_id UUID NOT NULL,   -- The user who follows
                create_date_time TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,
                update_date_time TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,

                CONSTRAINT fk_user_followed
                    FOREIGN KEY (user_id)
                    REFERENCES klic.users (id)
                    ON DELETE CASCADE,

                CONSTRAINT fk_user_follower
                    FOREIGN KEY (follower_id)
                    REFERENCES klic.users (id)
                    ON DELETE CASCADE,

                -- Prevent same user from following the same person twice
                CONSTRAINT uq_user_follower_pair
                    UNIQUE (user_id, follower_id),

                -- Prevent users from following themselves
                CONSTRAINT chk_no_self_follow
                    CHECK (user_id <> follower_id)
            );

            CREATE TABLE IF NOT EXISTS klic.user_feed (
                id UUID PRIMARY KEY,

                -- The user who receives the feed item
                user_id UUID NOT NULL,

                -- Reference to the related post
                post_id UUID NULL,

                -- Timestamps
                create_date_time TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,
                update_date_time TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,

                -- Foreign keys
                CONSTRAINT fk_feed_user
                    FOREIGN KEY (user_id) REFERENCES klic.users (id)
                    ON DELETE CASCADE,

                CONSTRAINT fk_feed_post
                    FOREIGN KEY (post_id) REFERENCES klic.posts (id)
                    ON DELETE SET NULL

            );



            commit;